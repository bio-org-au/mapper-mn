= Mapper V2.0
v2.0, September 2019
:toc: left
:toclevels: 4
:toc-class: toc2
:icons: font
:imagesdir: resources/images/
:stylesdir: resources/style/
:stylesheet: asciidoctor.css
:description: Mapper documentation
:keywords: documentation, Grails, Mapper, NSL, V2.0, micronaut
:links:
:numbered:
:sectlinks:

Mapper moved to Micronaut framework.

== Introduction

The *Mapper* maps URI *identifiers* to *resources* based on content negotiation. It is the place an ID is created and
mapped to a resource.

From that point on the mapped URI becomes a *permalink* that will always resolve.

The mapper manages de-duplication of resources by allowing you to move a mapping from one resource identifier to
another. It also manages deletion of resources allowing you to provide a reason for deleting a resource, which is
returned with a 410 GONE http response.

You can map a URI to different servers based on the content type requested, e.g. JSON, XML, RDF, HTML.

== Changes

* The broker endpoint is only for resolving IDs. In V1 preferred host and link were also obtained from the
`/broker/preferredLink` endpoint. This complicated the URL resolution for straight redirection brokering
(e.g. a resource proxy) and the API.
* all API calls are now under the `/api/blah`
* endpoints are moving from camel case to *skewer case* ie. `/broker/preferredHost` -> `/api/preferred-host`
* only serving up JSON, we will not respond with xml on our mapper API as it's not used
* get version of add-identifier has been deprecated, there are two new put versions of add-identifier
* removed bulkRemoveByUri as it wasn't used
* changed addURI  to add-uri-to-identity
* removed addIdentifierToUri as functionally equivalent to add uri to identifier

== Configuration

The broker uses Regex to pull apart the resolution requests. The Regex used for the broker expects there to be a /broker
in the context path. If you have a proxy in front of the mapper you may need to adjust the context path in this Regex.

You can set it in the nsl-mapper-config-mn.groovy or change the application.yml in the classpath. set the `mapper.brokerRegex`
in the configuration (see below).

The `urlRegex` shouldn't need to be changed, that is used by the mapper to get identities from a given URL.

[source, yaml]
.application.yml
----
mapper:
  brokerRegex: ^(https?://[^/]*)?/broker/(.*?)(/api/.*?)?(\.json|\.xml|\.rdf|\.html)?$
  urlRegex: ^(https?://[^/]*)?/?(.*?)(/api/.*?)?(\.json|\.xml|\.rdf|\.html)?$
----

=== Configure mapping

An external configuration file is used to configure the resource service to map a URL to.

[source, groovy]
.nsl-mapper-config-mn.groovy
----
import au.org.biodiversity.mapper.Identifier

mapper {
    resolverURL = 'http://localhost:7070/nsl-mapper'
    contextExtension = '' //extension to the context path (after nsl-mapper).
    defaultProtocol = 'http'
    Map serviceHosts = [
            bpni: 'http://bpni.com',
            apni: 'http://apni.com/nsl',
            ausmoss: 'http://ausmoss.com/nsl',
            algae: 'http://algae.net/thing',
            fungi: 'http://fungi.foo',
            foa : 'http://test.biodiversity.org.au/'
    ]

    Closure htmlResolver = { Identifier ident ->
        String host = serviceHosts[ident.nameSpace]
        if (ident.objectType == 'treeElement') {
            return "${host}/services/rest/${ident.objectType}/${ident.versionNumber}/${ident.idNumber}"
        }
        return "${host}/services/rest/${ident.objectType}/${ident.nameSpace}/${ident.idNumber}"
    }

    Closure jsonResolver = { Identifier ident ->
        String host = serviceHosts[ident.nameSpace]
        if (ident.objectType == 'treeElement') {
            return "${host}/services/json/${ident.objectType}/${ident.versionNumber}/${ident.idNumber}"
        }
        return "${host}/services/json/${ident.objectType}/${ident.nameSpace}/${ident.idNumber}"
    }

    format {
        html = htmlResolver
        json = jsonResolver
        xml = htmlResolver
        rdf = {Identifier ident -> return null}
    }

    auth = [
            'TEST-services': [
                    secret: 'buy-me-a-pony',
                    application: 'services',
                    roles      : ['admin'],
            ],
            'TEST-editor': [
                    secret: 'I-am-a-pony',
                    application: 'editor',
                    roles      : ['admin'],
            ]
    ]
}
----

== How it works

The mappers job is to permanently link URLs (URIs) to resources through content negotiation. It acts as a service broker
when given a resolvable URL.

The aim is to use a URL as the ID for a resource. Being a URL it is resolvable, and depending on the content type
requested different services may provide the resultant resource. The following sequence diagram shows the sequence of a
content resolution request.

.Sequence diagram of mapper requests
image::seq1.svg[]

=== Data structure
To do it's job the Mapper needs to know the URLs to map to a particular resource. The mapper defines two entities to
describe these:

* Match: The URI string.
* Identifier: The data used to uniquely identify a resource.

The Match and Identifier are linked as Many to Many relationships, so an Identifier can have many Matches (the usual case)
and a Match can have many Identifiers. The second case, where a Match has many Identifiers is used where there are many
resources that describe a particular ID. The resources all together describe the thing Identified. An example may be a
Taxanomic Name, which may have many concepts described in many publications by many authors. e.g.

* https://id.biodiversity.org.au/A%20Bastard%20White%20Mahogany

which returns a series of resources:

    https://biodiversity.org.au/nsl/services/rest/name/apni/442093
    https://biodiversity.org.au/nsl/services/rest/instance/apni/975779
    https://biodiversity.org.au/nsl/services/rest/instance/apni/975776

In the interests of speed and the typical use case, <<The Broker>> in this version of the mapper will redirect you to the first
resource found. The idea is that it would be better to have a single summary resource that directed you to the other resources.

The mapper also maps a Host to the URI (to make a URL). This allows historical URLs to work when a change of preferred
host occurs. We at IBIS have gone through the following host changes:

* biodiversity.org.au
* biodiversity.org.au/boa
* www.anbg.gov.au - original
* *id.biodiversity.org.au* - currently preferred

The change in host can happen for many reasons, and once a host is published in a URL we need to maintain it if possible.
Hosts are linked to specific Matches because the reverse proxy may only be able to resolve certain patterns. For example
the old link for Doodia R.Br. `https://biodiversity.org.au/apni.name/16512` uses the biodiversity.org.au host and works
because the reverse proxy can match the `apni.name` pattern.

A Match can have many hosts. When the mapper is asked for all the links to a resource it will mark the preferred link in
the list.


[source, JSON]
./api/links/name/apni/70914
----
[
  {
    "link": "http://biodiversity.org.au/boa/name/apni/70914",
    "resourceCount": 1,
    "preferred": false,
    "deprecated": false,
    "deleted": false
  },
  {
    "link": "http://localhost:7070/nsl-mapper/name/apni/70914",
    "resourceCount": 1,
    "preferred": false,
    "deprecated": false,
    "deleted": false
  },
  {
    "link": "http://localhost:7070/nsl-mapper/70914",
    "resourceCount": 1,
    "preferred": false,
    "deprecated": false,
    "deleted": false
  },
  {
    "link": "http://www.anbg.gov.au/cgi-bin/apni?taxon_id=16512",
    "resourceCount": 1,
    "preferred": false,
    "deprecated": true,
    "deleted": false
  },
  {
    "link": "http://biodiversity.org.au/apni.name/16512",
    "resourceCount": 1,
    "preferred": false,
    "deprecated": false,
    "deleted": false
  },
  {
    "link": "http://localhost:7070/nsl-mapper/Doodia R.Br.",
    "resourceCount": 15,
    "preferred": false,
    "deprecated": false,
    "deleted": false
  }
]
----

Here is the data structure of the mapper Database.

.Data structure
image::mapper.png[]

=== The Broker

